<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rainfun.github.io - Vocalost</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  height: 100vh;
  background: #121212;
  color: #fff;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding-right: 20px;
  overflow: hidden;
}
.chat-container {
  width: 500px;
  height: 80vh;
  border-radius: 10px;
  background: #1e1e1e;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  padding:10px;
}
.messages { flex:1; overflow-y:auto; margin-bottom:5px; }
.message { background:#333; color:#fff; border-radius:8px; padding:8px 12px; margin-bottom:10px; max-width:90%; word-wrap:break-word; position:relative; }
.message b { color:#fff; }
.message small { display:block; font-size:0.7rem; color:#fff; margin-top:2px;}
.reactions { margin-top:4px; display:flex; gap:5px; font-size:1rem; cursor:pointer; }
.emoji-picker { display:flex; flex-wrap:wrap; padding:5px; background:#2c2c2c; border-top:1px solid #444; max-height:100px; overflow-y:auto; }
.emoji-picker span { font-size:1.5rem; margin:5px; cursor:pointer; transition:transform 0.1s; }
.emoji-picker span:hover { transform: scale(1.3); }
.input-area { display:flex; border-top:1px solid #444; }
.input-area input { flex:1; padding:10px; border:none; border-radius:0 0 0 10px; outline:none; background:#2c2c2c; color:#fff; }
.input-area button { padding:10px 15px; border:none; background:#007bff; color:white; border-radius:0 0 10px 0; cursor:pointer; font-weight:bold; }
.input-area button:hover { background:#0056b3; }
.nickname-area { display:flex; padding:5px; gap:5px; }
.nickname-area input { flex:1; padding:5px; border-radius:5px; border:none; outline:none; background:#2c2c2c; color:#fff; }
.nickname-area button { padding:5px 10px; border-radius:5px; border:none; background:#007bff; color:#fff; cursor:pointer; }
.nickname-area button:hover { background:#0056b3; }
.replying { font-size:0.7rem; color:#ccc; margin-bottom:2px; }

/* Countdown panel */
#countdownPanel {
  position: fixed;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 220px;
  height: 130px;
  background: #111;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #fff;
  text-align: center;
  font-family: Arial, sans-serif;
  font-size: 1.5rem;
}
#timerText { margin-top:10px; font-size:2rem; }
</style>
</head>
<body>

<!-- Global countdown panel -->
<div id="countdownPanel">
  <div>‚è≥ Unlock Video In</div>
  <div id="timerText">00:00:00:00</div>
</div>
<audio id="tickSound" src="https://actions.google.com/sounds/v1/clock/analog_watch_tick.ogg" loop></audio>

<div class="chat-container">

  <div class="nickname-area">
    <input id="usernameInput" placeholder="Set your username (one-time)" maxlength="20"/>
    <button id="setUsernameBtn">Set</button>
    <input id="nicknameInput" placeholder="Change nickname anytime" maxlength="20"/>
    <button id="setNicknameBtn">Set</button>
  </div>

  <div class="messages" id="messages"></div>
  <div class="replying" id="replying"></div>

  <div class="emoji-picker" id="emojiPicker">
    <span>üòÄ</span><span>üòÇ</span><span>üòç</span><span>üòé</span>
    <span>üò¢</span><span>üò°</span><span>üëç</span><span>‚ù§Ô∏è</span>
    <span>üéâ</span><span>üíÄ</span><span>üî•</span>
  </div>

  <div class="input-area">
    <input id="msgInput" type="text" placeholder="Type a message..." maxlength="3000">
    <button id="sendBtn">Send</button>
  </div>

  <button id="voiceBtn" style="margin:5px; padding:8px; border:none; border-radius:5px; background:#007bff; color:#fff; cursor:pointer;">Voice Chat</button>

  <audio id="remoteAudio" autoplay></audio>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, updateDoc, arrayUnion, getDoc, setDoc, Timestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAUSdIAjFmgHJyDs7DPm_wqDfH5gTtgowI",
  authDomain: "anon-chat-7aeb8.firebaseapp.com",
  projectId: "anon-chat-7aeb8",
  storageBucket: "anon-chat-7aeb8.firebasestorage.app",
  messagingSenderId: "893900185108",
  appId: "1:893900185108:web:2c1d3e69adb019f5fa5101",
  measurementId: "G-QWS96HKVH8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- GLOBAL COUNTDOWN TIMER ----------
const TIMER_DOC = doc(db,"globalTimers","leftCountdown");
const TIMER_DURATION_MS = (2*24*60*60 + 6*60*60 + 50*60 + 20) * 1000; // 2d 6h 50m 20s
const timerText = document.getElementById("timerText");
const tickSound = document.getElementById("tickSound");

async function initTimer() {
  const docSnap = await getDoc(TIMER_DOC);
  let endTime;
  if(docSnap.exists()){
    endTime = docSnap.data().endTime.toMillis();
  } else {
    endTime = Date.now() + TIMER_DURATION_MS;
    await setDoc(TIMER_DOC,{endTime: Timestamp.fromMillis(endTime)});
  }

  tickSound.play();

  const interval = setInterval(()=>{
    const now = Date.now();
    let remaining = endTime - now;
    if(remaining <= 0){
      clearInterval(interval);
      timerText.textContent = "00:00:00:00";
      tickSound.pause();
      return;
    }
    const days = Math.floor(remaining / (1000*60*60*24));
    const hrs = Math.floor((remaining % (1000*60*60*24)) / (1000*60*60));
    const mins = Math.floor((remaining % (1000*60*60)) / (1000*60));
    const secs = Math.floor((remaining % (1000*60)) / 1000);
    timerText.textContent =
      `${String(days).padStart(2,'0')}:${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  },1000);
}
initTimer();

// ---------- RESET CHAT ONCE ----------
const RESET_FLAG = doc(db,"globalFlags","chatReset");
async function resetChatOnce() {
  const flagSnap = await getDoc(RESET_FLAG);
  if(!flagSnap.exists()){
    const msgs = await getDocs(collection(db,"messages"));
    msgs.forEach(async m=>await deleteDoc(doc(db,"messages",m.id)));
    await setDoc(RESET_FLAG,{done:true});
  }
}
resetChatOnce();

// ---------- CHAT CODE ----------
let username = localStorage.getItem("username") || "";
let nickname = localStorage.getItem("nickname") || "";
document.getElementById("usernameInput").value=username;
document.getElementById("nicknameInput").value=nickname;

let replyToId=null;
const cooldown=3000;
const lastSentKey="lastSentTime";

const messagesDiv=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const emojiPicker=document.getElementById("emojiPicker");
const replyingDiv=document.getElementById("replying");

const q=query(collection(db,"messages"),orderBy("timestamp","asc"));

onSnapshot(q,(snapshot)=>{
  messagesDiv.innerHTML="";
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    const div=document.createElement("div");
    div.classList.add("message");
    const replyText=msg.replyToUser ? `<div class="replying">Replying to ${msg.replyToUser}</div>` : "";
    const time=msg.timestamp?.toDate().toLocaleString() || "Just now";
    const displayName=msg.nickname||msg.user;
    div.innerHTML=`${replyText}<b>${displayName}:</b> ${msg.text} <small>${time}</small>`;

    const reactionsDiv=document.createElement("div");
    reactionsDiv.classList.add("reactions");
    const emojis=["üòÄ","üòÇ","üòç","üòé","üò¢","üò°","üëç","‚ù§Ô∏è","üéâ","üíÄ","üî•"];
    emojis.forEach(e=>{
      const span=document.createElement("span");
      span.textContent=e+(msg.reactions?.[e]?.length||"");
      span.onclick=async ()=>{
        const msgRef=doc(db,"messages",docSnap.id);
        await updateDoc(msgRef,{[`reactions.${e}`]:arrayUnion(username)});
      };
      reactionsDiv.appendChild(span);
    });

    const replyBtn=document.createElement("button");
    replyBtn.textContent="Reply";
    replyBtn.style.marginLeft="5px";
    replyBtn.style.background="#444";
    replyBtn.style.color="#fff";
    replyBtn.style.border="none";
    replyBtn.style.borderRadius="5px";
    replyBtn.style.cursor="pointer";
    replyBtn.onclick=()=>{ replyToId=docSnap.id; replyingDiv.textContent="Replying to "+displayName; msgInput.focus(); }

    div.appendChild(replyBtn);
    div.appendChild(reactionsDiv);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

sendBtn.onclick=async ()=>{
  const now=Date.now();
  const lastSent=parseInt(localStorage.getItem(lastSentKey))||0;
  if(now-lastSent<cooldown){ alert("Wait a few seconds."); return; }
  if(!username){ alert("Set your username first."); return; }
  if(msgInput.value.trim()==="") return;
  if(msgInput.value.length>3000){ alert("Message too long! Max 3000 characters."); return; }
  const data={ user:username, nickname:nickname||username, text:msgInput.value, timestamp:serverTimestamp(), reactions:{} };
  if(replyToId) data.replyTo=replyToId;
  if(replyToId) data.replyToUser="";
  await addDoc(collection(db,"messages"),data);
  msgInput.value="";
  localStorage.setItem(lastSentKey,now);
  replyToId=null;
  replyingDiv.textContent="";
}
msgInput.addEventListener("keypress",e=>{ if(e.key==="Enter") sendBtn.click(); });

emojiPicker.querySelectorAll("span").forEach(e=>{
  e.addEventListener("click",()=>{ msgInput.value+=e.textContent; msgInput.focus(); });
});

document.getElementById("setUsernameBtn").onclick=()=>{
  const val=document.getElementById("usernameInput").value.trim();
  if(!val){ alert("Enter username"); return; }
  if(val.length>20){ alert("Username max 20 characters."); return; }
  if(localStorage.getItem("username")){ alert("Username already set"); return; }
  username=val;
  localStorage.setItem("username",username);
  alert("Username set! Cannot change.");
};
document.getElementById("setNicknameBtn").onclick=()=>{
  const val=document.getElementById("nicknameInput").value.trim();
  if(!val) return;
  if(val.length>20){ alert("Nickname max 20 characters."); return; }
  nickname=val;
  localStorage.setItem("nickname",nickname);
};

// ---------- VOICE CHAT ----------
const voiceBtn=document.getElementById("voiceBtn");
const remoteAudio=document.getElementById("remoteAudio");
let pc;
let localStream;
const roomId="voice-room";

voiceBtn.onclick=async ()=>{
  localStream=await navigator.mediaDevices.getUserMedia({ audio:true });
  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack=(event)=>{ remoteAudio.srcObject=event.streams[0]; };
  const roomRef=doc(db,"voiceRooms",roomId);
  const offerCol=collection(roomRef,"offers");
  const answerCol=collection(roomRef,"answers");
  const candidatesCol=collection(roomRef,"candidates");

  pc.onicecandidate=async(event)=>{
    if(event.candidate){
      await addDoc(candidatesCol,{candidate:event.candidate.toJSON(), user:username});
    }
  };

  onSnapshot(candidatesCol,snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added" && change.doc.data().user!==username){
        try{ await pc.addIceCandidate(change.doc.data().candidate); }catch(e){console.error(e);}
      }
    });
  });

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await addDoc(offerCol,{sdp:offer.sdp,type:offer.type,user:username});

  onSnapshot(answerCol,snapshot=>{
    snapshot.docChanges().forEach(async change=>{
      if(change.type==="added"){
        const ans=change.doc.data();
        await pc.setRemoteDescription({type:ans.type,sdp:ans.sdp});
      }
    });
  });

  alert("Voice chat ready! Others in the same room can hear you.");
};
</script>
</body>
</html>
