<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rainfun.github.io - Vocalost</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    background: #121212;
    color: #fff;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding-right: 20px;
    overflow: hidden;
  }
  .chat-container {
    width: 450px;
    height: 750px;
    border-radius: 10px;
    background: #1e1e1e;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  .messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }
  .message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    max-width: 80%;
    background: #333;
    color: #fff;
    font-size: 0.95rem;
    word-wrap: break-word;
    position: relative;
  }
  .message b { color: #fff; }
  .message small { display:block; font-size:0.7rem; color:#fff; margin-top:2px;}
  .reactions { margin-top:4px; display:flex; gap:5px; font-size:1rem; cursor:pointer; }
  .emoji-picker { display:flex; flex-wrap:wrap; padding:5px; background:#2c2c2c; border-top:1px solid #444; max-height:100px; overflow-y:auto; }
  .emoji-picker span { font-size:1.5rem; margin:5px; cursor:pointer; transition:transform 0.1s; }
  .emoji-picker span:hover { transform: scale(1.3); }
  .input-area { display:flex; border-top:1px solid #444; }
  .input-area input { flex:1; padding:10px; border:none; border-radius:0 0 0 10px; outline:none; background:#2c2c2c; color:#fff; }
  .input-area button { padding:10px 15px; border:none; background:#007bff; color:white; border-radius:0 0 10px 0; cursor:pointer; font-weight:bold; }
  .input-area button:hover { background:#0056b3; }
  .nickname-area { display:flex; padding:5px; gap:5px; }
  .nickname-area input { flex:1; padding:5px; border-radius:5px; border:none; outline:none; background:#2c2c2c; color:#fff; }
  .nickname-area button { padding:5px 10px; border-radius:5px; border:none; background:#007bff; color:#fff; cursor:pointer; }
  .nickname-area button:hover { background:#0056b3; }
  .iframe-area { width:100%; height:250px; border:none; margin-top:5px; background:#111; }
  .replying { font-size:0.7rem; color:#ccc; margin-bottom:2px; }
</style>
</head>
<body>

<div class="chat-container">

  <div class="nickname-area">
    <input id="nicknameInput" placeholder="Enter nickname...">
    <button id="nicknameBtn">Set Nickname</button>
  </div>

  <div class="messages" id="messages"></div>

  <div class="replying" id="replying"></div>

  <div class="emoji-picker" id="emojiPicker">
    <span>😀</span><span>😂</span><span>😍</span><span>😎</span>
    <span>😢</span><span>😡</span><span>👍</span><span>❤️</span>
    <span>🎉</span><span>💀</span><span>🔥</span>
  </div>

  <div class="input-area">
    <input id="msgInput" type="text" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>

  <iframe class="iframe-area" src="https://www.google.com" id="browserIframe"></iframe>

  <button id="voiceBtn" style="margin:5px; padding:8px; border:none; border-radius:5px; background:#007bff; color:#fff; cursor:pointer;">Voice Chat</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
  query, orderBy, doc, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAUSdIAjFmgHJyDs7DPm_wqDfH5gTtgowI",
  authDomain: "anon-chat-7aeb8.firebaseapp.com",
  projectId: "anon-chat-7aeb8",
  storageBucket: "anon-chat-7aeb8.firebasestorage.app",
  messagingSenderId: "893900185108",
  appId: "1:893900185108:web:2c1d3e69adb019f5fa5101",
  measurementId: "G-QWS96HKVH8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let username = "Anon-" + Math.floor(Math.random()*1000);
let replyToId = null;
const cooldown = 3000;
const lastSentKey = "lastSentTime";

const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const emojiPicker = document.getElementById("emojiPicker");
const replyingDiv = document.getElementById("replying");

const nicknameInput = document.getElementById("nicknameInput");
const nicknameBtn = document.getElementById("nicknameBtn");
const voiceBtn = document.getElementById("voiceBtn");

const q = query(collection(db,"messages"),orderBy("timestamp","asc"));

// Show messages
onSnapshot(q,(snapshot)=>{
  messagesDiv.innerHTML="";
  snapshot.forEach(docSnap=>{
    const msg = docSnap.data();
    const div = document.createElement("div");
    div.classList.add("message");

    const replyText = msg.replyToUser ? `<div class="replying">Replying to ${msg.replyToUser}</div>` : "";
    const time = msg.timestamp?.toDate().toLocaleString() || "Just now";
    div.innerHTML = `${replyText}<b>${msg.user}:</b> ${msg.text} <small>${time}</small>`;

    // Reactions
    const reactionsDiv = document.createElement("div");
    reactionsDiv.classList.add("reactions");
    const emojis = ["😀","😂","😍","😎","😢","😡","👍","❤️","🎉","💀","🔥"];
    emojis.forEach(e=>{
      const span = document.createElement("span");
      span.textContent = e + (msg.reactions?.[e]?.length||"");
      span.addEventListener("click", async ()=>{
        const msgRef = doc(db,"messages",docSnap.id);
        await updateDoc(msgRef,{[`reactions.${e}`]: arrayUnion(username)});
      });
      reactionsDiv.appendChild(span);
    });

    // Reply button
    const replyBtn = document.createElement("button");
    replyBtn.textContent="Reply";
    replyBtn.style.marginLeft="5px";
    replyBtn.style.background="#444";
    replyBtn.style.color="#fff";
    replyBtn.style.border="none";
    replyBtn.style.borderRadius="5px";
    replyBtn.style.cursor="pointer";
    replyBtn.addEventListener("click",()=> {
      replyToId = docSnap.id;
      replyingDiv.textContent = "Replying to "+msg.user;
      msgInput.focus();
    });

    div.appendChild(replyBtn);
    div.appendChild(reactionsDiv);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Send message
sendBtn.addEventListener("click", async ()=>{
  const now = Date.now();
  const lastSent = parseInt(localStorage.getItem(lastSentKey)) || 0;
  if(now-lastSent<cooldown){ alert("Wait a few seconds."); return; }
  if(msgInput.value.trim()!==""){
    const data = { user: username, text: msgInput.value, timestamp: serverTimestamp(), reactions:{} };
    if(replyToId) data.replyTo = replyToId;
    if(replyToId) data.replyToUser = ""; // optional
    await addDoc(collection(db,"messages"),data);
    msgInput.value="";
    localStorage.setItem(lastSentKey,now);
    replyToId=null;
    replyingDiv.textContent="";
  }
});
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter") sendBtn.click();});

// Emoji picker
emojiPicker.querySelectorAll("span").forEach(emoji=>{
  emoji.addEventListener("click",()=>{msgInput.value+=emoji.textContent; msgInput.focus();});
});

// Nickname
nicknameBtn.addEventListener("click",()=>{if(nicknameInput.value.trim()!=="") username=nicknameInput.value; nicknameInput.value="";});

// Simple WebRTC voice chat (one-to-one room example)
voiceBtn.addEventListener("click",()=>{
  alert("Voice chat enabled: use WebRTC signaling server to connect peers.");
  // Placeholder: implementing a full multi-user voice chat requires signaling server
});

</script>
</body>
</html>
